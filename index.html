<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oliver_Scanner_V17_Grok</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* Paste your full original v16 CSS here — unchanged */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg:       #03050b;
  --bg2:      #070c16;
  --bg3:      #0d1520;
  --ink:      #ffffff;
  --ink2:     #ffffff;
  --ink3:     #cccccc;
  --ink4:     #5a7a96;
  --rule:     rgba(255,255,255,0.07);
  --rule2:    rgba(255,255,255,0.04);
  --buy:      #00ff88;
  --buy-bg:   rgba(0,255,136,0.07);
  --buy-rule: rgba(0,255,136,0.35);
  --sell:     #ff1744;
  --sell-bg:  rgba(255,23,68,0.07);
  --sell-rule:rgba(255,23,68,0.35);
  --hold:     #ffe600;
  --hold-bg:  rgba(255,230,0,0.06);
  --hold-rule:rgba(255,230,0,0.35);
  --narrow:   #00b4ff;
  --narrow-bg:rgba(0,180,255,0.07);
  --expand:   #ff8c00;
  --expand-bg:rgba(255,140,0,0.07);
}

html { font-size:13px; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'DM Sans', sans-serif;
  font-weight: 300;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  display: flex;
  flex-direction: column;
}

/* … paste the rest of your original v16 CSS here (gate-bar through to end) … */
/* If you don't have it copied, use the CSS from your previous v16 file */

.api-status-row.success { color: var(--buy); font-weight: bold; }
.api-status-row.error   { color: var(--sell); font-weight: bold; }
</style>
</head>
<body>

<!-- Your original HTML structure – gate bar, header, edit bar, tf bar, legend, grid, overlays, etc. -->
<!-- Paste your full v16 <body> content here, keeping the API panel section -->

<!-- Updated API Settings Overlay with FMP focus -->
<div class="api-overlay" id="apiOverlay" onclick="closeApiPanel()"></div>
<div class="api-panel" id="apiPanel">
  <div class="api-title">Oliver_Scanner_V17_Grok – Data Source</div>

  <div class="api-provider active" id="prov-fmp" onclick="selectProvider('fmp')">
    <div class="provider-dot" style="background:#00b4ff"></div>
    <div>
      <div class="api-provider-name">Financial Modeling Prep (FMP)</div>
      <div class="api-provider-tier">Real-time quotes + 1-min bars • Aggregate to 2-min • $19/mo Starter</div>
    </div>
    <div class="api-provider-price">$19/mo</div>
  </div>

  <div class="api-provider" id="prov-yahoo" onclick="selectProvider('yahoo')">
    <div class="provider-dot" style="background:#888"></div>
    <div>
      <div class="api-provider-name">Yahoo Finance (Demo/Fallback)</div>
      <div class="api-provider-tier">Free • No key • 15-min delay on stocks</div>
    </div>
    <div class="api-provider-price">$0</div>
  </div>

  <div class="api-key-row" id="keyRow">
    <div class="api-key-label">FMP API Key</div>
    <input class="api-key-input" id="apiKeyInput" type="password" placeholder="Paste your FMP API key (financialmodelingprep.com)" autocomplete="off">
  </div>

  <div class="api-btn-row">
    <button class="api-btn api-btn-cancel" onclick="closeApiPanel()">Cancel</button>
    <button class="api-btn api-btn-save" onclick="saveApiSettings()">⚡ Connect & Scan</button>
  </div>
  <div class="api-status-row" id="apiStatusMsg"></div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ── Paste your original v16 JavaScript here (all functions, variables, etc.) ──
// Then add/replace with these updates:

let currentProvider = localStorage.getItem('ov_provider') || 'fmp';
let apiKey = localStorage.getItem('ov_apikey') || '';

// Force FMP as default on first load
if (!localStorage.getItem('ov_provider')) {
  currentProvider = 'fmp';
  localStorage.setItem('ov_provider', 'fmp');
}

// Update selectProvider to handle FMP
function selectProvider(p) {
  document.querySelectorAll('.api-provider').forEach(el => el.classList.remove('active'));
  document.getElementById(`prov-${p}`).classList.add('active');
  currentProvider = p;
  const needsKey = p !== 'yahoo';
  document.getElementById('keyRow').style.display = needsKey ? 'block' : 'none';
  if (p === 'fmp') {
    document.getElementById('apiKeyInput').placeholder = 'Paste your FMP API key (financialmodelingprep.com)';
  }
}

// Save settings – focus on FMP
function saveApiSettings() {
  const msg = document.getElementById('apiStatusMsg');
  apiKey = document.getElementById('apiKeyInput').value.trim();

  if (currentProvider !== 'yahoo' && !apiKey) {
    msg.className = 'api-status-row error';
    msg.textContent = 'Please enter your FMP API key';
    return;
  }

  localStorage.setItem('ov_provider', currentProvider);
  localStorage.setItem('ov_apikey', apiKey);

  msg.className = 'api-status-row success';
  msg.textContent = '✓ Connected to FMP – fetching live data...';

  setTimeout(() => {
    document.getElementById('apiOverlay').style.display = 'none';
    document.getElementById('apiPanel').style.display = 'none';
    fetchLiveData();
  }, 1500);
}

// ── FMP Fetch – 1min bars → aggregate to 2min ──────────────────────────────
async function fetchFMP(sym) {
  if (!apiKey) return null;

  const proxy = 'https://api.allorigins.win/raw?url=';
  const url = encodeURIComponent(`https://financialmodelingprep.com/api/v3/historical-chart/1min/${sym}?apikey=${apiKey}`);

  try {
    const res = await fetch(proxy + url, { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    if (!Array.isArray(json) || json.length < 10) return null;

    // FMP returns newest first → reverse to oldest first
    let bars = json.reverse();

    // Aggregate to 2-min
    let bars2min = [];
    for (let i = 0; i < bars.length; i += 2) {
      if (bars[i+1]) {
        bars2min.push({
          o: bars[i].open,
          h: Math.max(bars[i].high, bars[i+1].high),
          l: Math.min(bars[i].low, bars[i+1].low),
          c: bars[i+1].close,
          v: (bars[i].volume || 0) + (bars[i+1].volume || 0)
        });
      } else {
        bars2min.push(bars[i]);
      }
    }

    histFull[sym] = bars2min;
    hist[sym] = bars2min.map(b => b.c);

    return bars2min.map(b => ({ c: b.c, o: b.o, h: b.h, l: b.l }));
  } catch (e) {
    console.error('FMP error:', sym, e.message);
    return null;
  }
}

// Update fetchSymbolLive to use FMP first
async function fetchSymbolLive(sym) {
  if (currentProvider === 'fmp') return await fetchFMP(sym);
  if (currentProvider === 'yahoo') return await fetchYahoo(sym); // your original function
  return null;
}

// In fetchLiveData – show FMP-specific status
// … (keep your original fetchLiveData logic, just update the success message)
if (successCount > 0) {
  demoMode = false;
  liveIndicator.textContent = `● LIVE FMP (${successCount}/${allSyms.length} symbols)`;
  liveIndicator.style.color = '#00ff88';
} else {
  demoMode = true;
  liveIndicator.textContent = `● DEMO / FMP issue – check key or connection`;
  liveIndicator.style.color = '#888';
}

// Auto-show API panel if no FMP key
if (currentProvider === 'fmp' && !apiKey) {
  document.getElementById('apiOverlay').style.display = 'block';
  document.getElementById('apiPanel').style.display = 'block';
} else {
  startLiveData();
}

// … rest of your original script (runScan, renderAll, clock, toast, etc.) …
</script>
</body>
</html>
